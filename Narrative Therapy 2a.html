<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Section 2a ‚Äì Significant Life Events</title>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 0;
      background: radial-gradient(circle at top, #0f172a 0, #1e3a8a 25%, #4f46e5 55%, #ec4899 100%);
      color: #111827;
    }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    .sidebar {
      width: 260px;
      flex: 0 0 260px;
      position: sticky;
      top: 16px;
      align-self: flex-start;
    }

    .page { flex: 1; min-width: 0; }

    h1 {
      font-size: 1.9rem;
      margin-bottom: 0.4rem;
      display: flex; align-items: center; gap: 8px;
      color: #f9fafb;
      text-shadow: 0 2px 10px rgba(0,0,0,0.45);
    }

    h1 .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(251,191,36,0.95);
      color: #78350f;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
    }

    p.intro {
      margin-top: 0;
      margin-bottom: 1.2rem;
      font-size: 0.95rem;
      color: #e5e7eb;
      max-width: 760px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    /* ------- Sidebar Gamify Panel ------- */
    .gamify-panel {
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(30,64,175,0.98));
      border-radius: 18px;
      padding: 10px 14px;
      border: 1px solid rgba(191,219,254,0.3);
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
      color: #e5e7eb;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .gamify-panel::before {
      content: "";
      position: absolute;
      inset: -40%;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(251,191,36,0.3) 0, transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(236,72,153,0.3) 0, transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(34,197,94,0.3) 0, transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .gamify-inner { position: relative; z-index: 1; }

    .gamify-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      font-size: 0.84rem;
    }

    #scoreLabel {
      font-weight: 700;
      font-size: 0.9rem;
      background: rgba(15,23,42,0.8);
      padding: 3px 8px;
      border-radius: 999px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.7);
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #fbbf24, #fb923c, #ec4899, #22c55e);
      background-size: 200% 100%;
      animation: progressGlow 4s linear infinite;
      transition: width 0.3s ease-out;
    }

    @keyframes progressGlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    /* Hide the text under the progress bar */
    .progress-label {
      display: none;
    }

    .quest-log {
      border-top: 1px solid rgba(148,163,184,0.35);
      margin-top: 4px;
      padding-top: 4px;
    }

    .quest-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 2px;
    }

    .quest-list {
      list-style: none;
      margin: 0; padding: 0;
      font-size: 0.75rem;
    }

    .quest-list li {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .quest-badge {
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(209,213,219,0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      background: rgba(15,23,42,0.8);
    }

    .quest-list li.completed { color: #bbf7d0; }
    .quest-list li.completed .quest-badge {
      background: radial-gradient(circle at 30% 0, #fef3c7 0, #22c55e 40%, #166534 100%);
      border-color: #bbf7d0;
      box-shadow: 0 0 6px rgba(34,197,94,0.9);
    }
    .quest-list li.completed .quest-badge::before { content: "‚úì"; }

    .reward-flash {
      font-size: 0.78rem;
      color: #fef3c7;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }
    .reward-flash.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ----- Timer ----- */
    .timer {
      display: inline-flex;
      flex-direction: column;
      gap: 3px;
      padding: 8px 11px;
      border-radius: 16px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(248,250,252,0.2);
      box-shadow: 0 6px 18px rgba(15,23,42,0.7);
      color: #e5e7eb;
      font-size: 0.88rem;
    }

    .timer span.time {
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: 0.08em;
    }

    .timer.ending { border-color: #f97373; color: #fecaca; }
    .timer.up { opacity: 0.7; }

    .time-up-banner {
      display: none;
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(254,242,242,0.96);
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .time-up .time-up-banner { display: block; }

    /* ------- Cards ------- */
    .card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 18px 16px;
      box-shadow: 0 10px 22px rgba(15,23,42,0.25);
      border: 1px solid #e5e7eb;
      margin-bottom: 18px;
      position: relative;
    }

    .card-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #111827;
    }

    textarea, input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      resize: vertical;
      min-height: 70px;
      font: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    textarea:focus, input[type="text"]:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(129,140,248,0.4);
    }

    .options-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 8px 0 10px;
    }

    .option-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(129,140,248,0.7);
      background: rgba(239,246,255,0.95);
      cursor: pointer;
    }

    .option-pill.selected {
      background: linear-gradient(135deg, #22c55e, #a855f7);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(55,65,81,0.7);
    }

    .step { display: none; }
    .step.active { display: block; }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 14px;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-weight: 700;
      font-size: 0.9rem;
      background: radial-gradient(circle at 0% 0%, #f97316, #ec4899, #6366f1);
      color: #fff;
      box-shadow: 0 8px 18px rgba(15,23,42,0.7);
    }

    button:disabled { opacity: 0.45; }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 4px 10px rgba(55,65,81,0.5);
    }

    #resultsBox {
      width: 100%;
      min-height: 200px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      background: #fff;
      white-space: pre-wrap;
    }

  </style>
</head>

<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <div class="gamify-panel">
      <div class="gamify-inner">

        <div class="gamify-header">
          <strong>Narrative Progress</strong>
          <!-- Removed 'XP' text -->
          <span id="scoreLabel">0</span>
        </div>

        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>

        <div id="progressText" class="progress-label">
          0% ‚Äì begin your journey through significant life events
        </div>

        <div class="quest-log">
          <div class="quest-title">Questions Completed</div>
          <ul class="quest-list">
            <li id="quest1"><span class="quest-badge"></span>Complete Question 1</li>
            <li id="quest2"><span class="quest-badge"></span>Complete Question 2</li>
            <li id="quest3"><span class="quest-badge"></span>Complete Question 3</li>
            <li id="quest4"><span class="quest-badge"></span>Finish & Copy Reflection</li>
          </ul>
        </div>

        <div id="rewardFlash" class="reward-flash">
          ‚≠ê +10 gained!
        </div>

      </div>
    </div>

    <div id="timer" class="timer">
      <span>‚è±Ô∏è Time left (Section 2a)</span>
      <span id="timeRemaining" class="time">30:00</span>
      <span style="font-size:0.75rem; opacity:0.75;">Up to 30 minutes to complete this week's narrative.</span>
    </div>

  </aside>

  <!-- MAIN CONTENT -->
  <main class="page">

    <!-- Removed 'Narrative Quest' badge text -->
    <h1>Section 2a: Significant Life Events</h1>

    <p class="intro">
      This sequence explores meaningful experiences, milestones, and challenges that have shaped your identity.
    </p>

    <div id="timeUpBanner" class="time-up-banner">
      Your 30 minutes are finished. You may still review and copy your responses.
    </div>

    <!-- FORM START -->
    <form id="reflectionForm">
<!-- STEP 1 ‚Äì QUESTION 1 -->
<div class="step active" data-step="1">

  <div class="card question"
       data-question="1. Moments that bring joy or happiness">

    <div class="card-title">
      Question 1 ‚Äì Moments of Joy or Happiness
    </div>

    <div class="sub-question" data-subquestion="1a. What brings you the most consistent joy?">

      <div class="sub-question-title">
        Reflect on a moment when you feel the most consistent joy or happiness.
      </div>

      <div class.question-text>
        What kind of moment brings you the most consistent joy or happiness in your life?
      </div>

      <div class="options-group">

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Achieving a long-sought goal or meaningful milestone">
          A. Achieving a long-sought goal or meaningful milestone.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Spending quality time with loved ones">
          B. Spending quality time with loved ones.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Experiencing something new or exciting">
          C. Experiencing something new or exciting.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="A simple, quiet moment of peace or contentment">
          D. A simple, quiet moment of peace or contentment.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="No significant moment, but smaller moments bring occasional happiness">
          E. Smaller occasional moments of happiness.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Engaging in activities aligned with your values">
          F. Engaging in activities aligned with your values.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Participating in group activities and shared accomplishments">
          G. Participating in group activities and shared accomplishments.
        </label>

        <label class="option-pill">
          <input type="radio" name="q1a"
                 value="Other / Not listed">
          H. Other / Not listed (please specify):
        </label>

      </div>

      <textarea id="q1a_other"
        placeholder="If ‚ÄòOther‚Äô or if you‚Äôd like to describe this joyful moment more fully, write here."></textarea>

    </div>

    <div class="sub-question" data-subquestion="1b. Why this moment stands out">

      <div class="sub-question-title">Optional Follow-Up</div>

      <div class="question-text">
        What makes moments like this stand out most in your memory, and how do they impact your overall perspective on life and happiness?
      </div>

      <textarea id="q1_follow"
        placeholder="You may describe how these moments influence your view of happiness or what you appreciate in life."></textarea>

    </div>
  </div>

  <div class="nav-buttons">
    <span></span>
    <button id="next1" type="button" disabled>Next Question ‚Æï</button>
  </div>

</div>


<!-- STEP 2 ‚Äì QUESTION 2 -->
<div class="step" data-step="2">

  <div class="card question"
       data-question="2. Milestones you are proud of">

    <div class="card-title">
      Question 2 ‚Äì Milestones You Are Proud Of
    </div>

    <div class="sub-question"
         data-subquestion="2a. Type of milestone you are proud of">

      <div class="sub-question-title">
        Think about milestones or achievements you feel most proud of.
      </div>

      <div class="question-text">
        What type of milestones or achievements are you most proud of?
      </div>

      <div class="options-group">

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="A professional or academic accomplishment">
          A. A professional or academic accomplishment.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="Overcoming a personal challenge">
          B. Overcoming a personal challenge.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="A relationship-related or family milestone">
          C. A relationship-related or family milestone.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="Contribution to a cause or helping others">
          D. Contributing to a cause or helping others.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="No milestone yet but hope for one">
          E. I haven‚Äôt achieved a milestone I feel proud of yet.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="Gaining meaningful recognition from others">
          F. Gaining meaningful recognition from peers or community.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="Making a lasting positive impact through leadership or creativity">
          G. Making a lasting positive impact through leadership or creativity.
        </label>

        <label class="option-pill">
          <input type="radio" name="q2a"
                 value="Other / Not listed">
          H. Other / Not listed (please specify):
        </label>

      </div>

      <textarea id="q2a_other"
        placeholder="If ‚ÄòOther‚Äô or if you‚Äôd like to describe this milestone further, write here."></textarea>

    </div>

    <div class="sub-question"
         data-subquestion="2b. How milestone influenced your confidence">

      <div class="sub-question-title">Optional Follow-Up</div>

      <div class="question-text">
        How did achieving this milestone influence your confidence or sense of self-worth, and how does it continue to shape your goals and aspirations?
      </div>

      <textarea id="q2_follow"
        placeholder="Describe the long-term importance or meaning of this milestone."></textarea>

    </div>
  </div>

  <div class="nav-buttons">
    <button type="button" id="back2" class="secondary">‚Æú Back</button>
    <button type="button" id="next2" disabled>Next Question ‚Æï</button>
  </div>

</div>




<!-- STEP 3 ‚Äì QUESTION 3 -->
<div class="step" data-step="3">

  <div class="card question"
       data-question="3. Significant challenges you faced">

    <div class="card-title">
      Question 3 ‚Äì Significant Challenges You Faced
    </div>

    <div class="sub-question"
         data-subquestion="3a. Type of challenge you faced">

      <div class="sub-question-title">
        Reflect on a time when you faced a significant challenge or obstacle.
      </div>

      <div class="question-text">
        What type of challenge did you face?
      </div>

      <div class="options-group">

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="A personal challenge (health, emotions, self-doubt)">
          A. A personal challenge (health, emotions, self-doubt, etc.)
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="A relationship-related issue">
          B. A relationship-related issue.
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="A professional or academic obstacle">
          C. A professional or academic obstacle.
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="A life-situation challenge (financial, moving, caregiving)">
          D. A life-situation challenge (financial strain, moving, caregiving).
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="No significant challenge recalled">
          E. No significant challenge recalled.
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="A societal or systemic challenge">
          F. A societal or systemic challenge.
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="Balancing competing priorities">
          G. Balancing competing priorities.
        </label>

        <label class="option-pill">
          <input type="radio" name="q3a"
                 value="Other / Not listed">
          H. Other / Not listed (please specify):
        </label>

      </div>

      <textarea id="q3a_other"
        placeholder="If ‚ÄòOther‚Äô or if you‚Äôd like to describe the challenge more fully, write here."></textarea>

    </div>

    <div class="sub-question"
         data-subquestion="3b. What you learned about resilience">

      <div class="sub-question-title">Optional Follow-Up</div>

      <div class="question-text">
        What did you learn about your inner strengths, resilience, or problem-solving skills through this experience, and how has it shaped you?
      </div>

      <textarea id="q3_follow"
        placeholder="Reflect on the strengths you discovered or developed."></textarea>

    </div>

  </div>

  <div class="nav-buttons">
    <button type="button" id="back3" class="secondary">‚Æú Back</button>
    <button type="button" id="finishBtn" disabled>Finish</button>
  </div>

</div>

</form> <!-- END FORM -->


<!-- RESULTS SECTION -->
<div id="resultsSection" style="display:none; margin-top:20px;">

  <h2 style="color:#f9fafb; text-shadow:0 2px 6px rgba(0,0,0,0.45);">
    Your Reflection Export
  </h2>

  <p class="intro">
    Below is your formatted reflection. Copy and paste it wherever needed.
  </p>

  <button id="copyButton" type="button">üìã Copy this reflection</button>
  <div id="statusMessage" class="status"></div>

  <textarea id="resultsBox" readonly></textarea>

</div>

</main>
</div> <!-- END LAYOUT -->
<script>
// ------------------------
// SECTION 2a ‚Äì FULL JS
// ------------------------

// ========== TIMER (30 MINUTES) ==========
var totalSeconds = 30 * 60;
var timerInterval = null;
var timerEl = document.getElementById("timer");
var timeRemainingEl = document.getElementById("timeRemaining");
var timeUpBanner = document.getElementById("timeUpBanner");
var timeUp = false;

function formatTime(seconds) {
    var m = Math.floor(seconds / 60);
    var s = seconds % 60;
    return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
}

function startTimer() {
    timeRemainingEl.textContent = formatTime(totalSeconds);

    timerInterval = setInterval(function () {
        totalSeconds--;

        if (totalSeconds <= 0) {
            totalSeconds = 0;
            clearInterval(timerInterval);
            triggerTimeUp();
        }

        timeRemainingEl.textContent = formatTime(totalSeconds);

        if (totalSeconds <= 60 && !timeUp) {
            if (timerEl.className.indexOf("ending") === -1) {
                timerEl.className += " ending";
            }
        }
    }, 1000);
}

function triggerTimeUp() {
    timeUp = true;

    timerEl.className = timerEl.className.replace(" ending", "");
    if (timerEl.className.indexOf("up") === -1) {
        timerEl.className += " up";
    }

    document.body.className += " time-up";
    timeUpBanner.style.display = "block";

    var allInputs = document.querySelectorAll("#reflectionForm input, #reflectionForm textarea");
    for (var i = 0; i < allInputs.length; i++) {
        allInputs[i].disabled = true;
    }
}

// ========== STEP CONTROL ==========
var steps = document.querySelectorAll(".step");
var currentStep = 1;
var totalSteps = steps.length;

function showStep(stepNumber) {
    for (var i = 0; i < steps.length; i++) {
        var step = steps[i];
        var isTarget = Number(step.getAttribute("data-step")) === stepNumber;

        if (isTarget) {
            if (step.className.indexOf("active") === -1) {
                step.className += " active";
            }
        } else {
            step.className = step.className.replace(" active", "");
        }
    }

    currentStep = stepNumber;
    updateProgress();
}

// ========== PROGRESS SYSTEM ==========
var progressFill = document.getElementById("progressFill");
var progressText = document.getElementById("progressText");
var scoreLabel = document.getElementById("scoreLabel");

var quest1 = document.getElementById("quest1");
var quest2 = document.getElementById("quest2");
var quest3 = document.getElementById("quest3");
var quest4 = document.getElementById("quest4");

var copiedOnce = false;

var rewardFlash = document.getElementById("rewardFlash");
var rewardTimeout = null;

function isMainAnswered(stepNumber) {
    var step = document.querySelector('.step[data-step="' + stepNumber + '"]');
    if (!step) return false;

    var checked = step.querySelector("input[type='radio']:checked, input[type='checkbox']:checked");
    if (checked) return true;

    var textFields = step.querySelectorAll("textarea,input[type='text']");
    for (var i = 0; i < textFields.length; i++) {
        if (textFields[i].value.trim() !== "") return true;
    }

    return false;
}

function answeredCount() {
    var count = 0;
    for (var i = 1; i <= totalSteps; i++) {
        if (isMainAnswered(i)) count++;
    }
    return count;
}

function questCompleted(li, done) {
    if (!li) return;
    if (done) {
        if (li.className.indexOf("completed") === -1)
            li.className += " completed";
    } else {
        li.className = li.className.replace("completed", "").trim();
    }
}

function updateQuestList() {
    questCompleted(quest1, isMainAnswered(1));
    questCompleted(quest2, isMainAnswered(2));
    questCompleted(quest3, isMainAnswered(3));

    questCompleted(quest4, answeredCount() === totalSteps && copiedOnce);
}

function flashReward(message) {
    if (rewardTimeout) clearTimeout(rewardTimeout);

    rewardFlash.textContent = message;

    if (rewardFlash.className.indexOf("visible") === -1) {
        rewardFlash.className += " visible";
    }

    rewardTimeout = setTimeout(function () {
        rewardFlash.className = rewardFlash.className.replace("visible", "");
    }, 1500);
}

var rewardState = {1:false, 2:false, 3:false};

function checkReward(stepNumber) {
    var now = isMainAnswered(stepNumber);

    if (now && !rewardState[stepNumber]) {
        rewardState[stepNumber] = true;
        // Removed 'XP' from the reward message
        flashReward("‚≠ê +100 ‚Äì Question " + stepNumber + " logged!");
    }

    updateProgress();
}

function updateProgress() {
    var answered = answeredCount();
    var percent = Math.round((answered / totalSteps) * 100);
    var xp = answered * 100;

    progressFill.style.width = percent + "%";
    // Removed 'XP' from score label
    scoreLabel.textContent = xp;

    if (percent === 0) {
        progressText.textContent = "0% ‚Äì your reflection journey begins üí°";
    } else if (percent < 100) {
        progressText.textContent = percent + "% ‚Äì keep going, you're exploring deeply ‚ú®";
    } else {
        progressText.textContent = "100% ‚Äì all questions completed, final reflection unlocked üèÖ";
    }

    updateQuestList();
}

// ========== OPTION PILL UI ==========
function closestWithClass(node, className, stopAt) {
    while (node && node !== stopAt) {
        if ((" " + node.className + " ").indexOf(" " + className + " ") > -1) return node;
        node = node.parentNode;
    }
    return null;
}

var optionGroups = document.querySelectorAll(".options-group");

for (var g = 0; g < optionGroups.length; g++) {
    optionGroups[g].addEventListener("change", function (e) {
        var target = e.target || e.srcElement;
        if (!target || target.tagName !== "INPUT") return;

        var pill = closestWithClass(target, "option-pill", this);
        if (!pill) return;

        if (target.type === "radio") {
            var all = this.querySelectorAll(".option-pill");
            for (var i = 0; i < all.length; i++) {
                all[i].className = all[i].className.replace("selected", "");
            }
            pill.className += " selected";
        } else if (target.type === "checkbox") {
            if (target.checked) pill.className += " selected";
            else pill.className = pill.className.replace("selected", "");
        }

        var stepEl = closestWithClass(target, "step", document.body);
        var sNum = Number(stepEl.getAttribute("data-step"));
        enableButtons(sNum);
        checkReward(sNum);
    });
}

document.getElementById("reflectionForm").addEventListener("input", function (e) {
    var stepEl = closestWithClass(e.target, "step", document.body);
    if (stepEl) {
        var stepNum = Number(stepEl.getAttribute("data-step"));
        enableButtons(stepNum);
        checkReward(stepNum);
    }
});

// ========== BUTTON STATE ==========
function enableButtons(stepNumber) {
    var answered = isMainAnswered(stepNumber);

    if (stepNumber === 1) document.getElementById("next1").disabled = !answered;
    if (stepNumber === 2) document.getElementById("next2").disabled = !answered;
    if (stepNumber === 3) document.getElementById("finishBtn").disabled = !answered;
}

// ========== NAV BUTTONS ==========
document.getElementById("next1").onclick = function () { showStep(2); };
document.getElementById("back2").onclick = function () { showStep(1); };
document.getElementById("next2").onclick = function () { showStep(3); };
document.getElementById("back3").onclick = function () { showStep(2); };

document.getElementById("finishBtn").onclick = function () {
    generateExport();
    document.getElementById("resultsSection").style.display = "block";
    copiedOnce = false;
    updateProgress();

    this.style.display = "none";
    document.getElementById("resultsSection").scrollIntoView({behavior:"smooth"});
};

// ========== EXPORT BUILDER ==========
var dashLine =
"- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -";

function generateExport() {
    var output = "";
    var questions = document.querySelectorAll(".question");

    output += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    output += "Section 2a ‚Äì Significant Life Events: Reflection Summary\n";
    output += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";

    for (var q = 0; q < questions.length; q++) {
        var qBlock = questions[q];
        var title = qBlock.getAttribute("data-question");

        output += "\n\n============================================================\n";
        output += title + "\n";
        output += "============================================================\n";

        var subs = qBlock.querySelectorAll(".sub-question");
        for (var s = 0; s < subs.length; s++) {
            var sub = subs[s];
            var label = sub.getAttribute("data-subquestion");

            output += "\n‚ñ∏ " + label + "\n";

            // Options
            var groups = sub.querySelectorAll(".options-group");
            for (var g = 0; g < groups.length; g++) {
                var group = groups[g];
                var opts = group.querySelectorAll("label.option-pill");

                if (opts.length > 0) {
                    // Removed '(* = chosen)' wording
                    output += "Options:\n";

                    for (var o = 0; o < opts.length; o++) {
                        var lab = opts[o];
                        var input = lab.querySelector("input");
                        var text = lab.textContent.trim();
                        var chosen = input.checked ? "* " : "  ";

                        output += chosen + text + "\n";
                        output += dashLine + "\n";
                    }
                }
            }

            // Written notes
            var fields = sub.querySelectorAll("textarea,input[type='text']");
            var notes = [];

            for (var f = 0; f < fields.length; f++) {
                if (fields[f].value.trim() !== "") {
                    notes.push(fields[f].value.trim());
                }
            }

            output += "Notes:\n";
            if (notes.length === 0) {
                output += "‚Ä¢ (no extra written reflections)\n";
            } else {
                for (var n = 0; n < notes.length; n++) {
                    output += "‚Ä¢ " + notes[n] + "\n";
                }
            }
        }
    }

    output += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    output += "End of Section 2a\n";
    output += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

    document.getElementById("resultsBox").value = output;
}

// ========== COPY BUTTON ==========
document.getElementById("copyButton").onclick = function () {
    var box = document.getElementById("resultsBox");
    var text = box.value;
    var status = document.getElementById("statusMessage");

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(function () {
                status.textContent = "‚ú® Reflection copied! Paste it wherever needed.";
                copiedOnce = true;
                updateProgress();
            })
            .catch(function () {
                status.textContent = "Copy failed ‚Äî please copy manually.";
            });
    } else {
        box.select();
        try {
            var successful = document.execCommand("copy");
            if (successful) {
                status.textContent = "‚ú® Reflection copied!";
                copiedOnce = true;
                updateProgress();
            } else {
                status.textContent = "Copy failed ‚Äî please copy manually.";
            }
        } catch (err) {
            status.textContent = "Copy failed ‚Äî please copy manually.";
        }
    }
};


// ========== INITIALISATION ON PAGE LOAD ==========
window.onload = function () {
    startTimer();
    updateProgress();
    enableButtons(1);
};

</script>
